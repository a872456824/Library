# 7.shell编程基础

- ## 第一个Shell脚本

  ```shell
  #!/bin/bash
  #注释
  echo "Hello"
  复制代码
  ```

  - 第一行#!指定解释器，只在第一行才有效
  - 注释："#"

  ## 变量

  ```shell
  a=123
  a=hello
  a=`pwd`
  PATH=${PATH}:path  # 变量后接字符串，可以直接拼接字符串
  # 【注意】":a"有特殊含义，会指到当前路径
  ```
  
- 不需要定义变量类型【弱类型语言】
    - 如a=123可以是字符串，也可以是整数
  - ":a"有特殊含义
    - ![image-20201215182921590](../../../Image/image-20201215182921590.png)
    - 可用双引号包住a，如a=a:"a"或a=*a*:"*a*"或*a*=a":a"，得到a=123:a
  
### 特殊变量

**位置变量**

![img](../../../Image/20201215192821.png)

结果：

![image-20201215174953312](../../../Image/image-20201215174953312.png)

- $n：如果n＞9，需要用大括号括起来
  - $@ 和 $* 的区别在于：$* 和 $@ 都表示传递给函数或脚本的所有参数，不被双引号(" ")包含时，都以"$1" "$2" … "$n" 的形式输出所有参数。但是当它们被双引号(" ")包含时，"$*" 会将所有的参数作为一个整体，以"$1 $2 … $n"的形式输出所有参数；"$@" 会将各个参数分开，以"$1" "$2" … "$n" 的形式输出所有参数。
    - 在用for...in 时可以看出，详见Shell特殊变量：[Shell $0, $#, $*, $@, $?, $$和命令行参数](http://c.biancheng.net/cpp/view/2739.html)——C语言中文网
  - $#：不计数$0
  -  $# : 传递给脚本或函数的参数个数，类似于c语言中变参函数的第一个参数

  **状态变量**

  - $?：【上一条】指令执行结果，0——成功，非0——不成功
    - ![图片](../../../Image/WZxQPRI.png)
    - 便于脚本自动判断指令成功与否
  - $!：当前进程/上一指令的PID，一般用于自动化测试、多脚本交互场景
  - 输入：read
  - <img src="../../../Image/Image-1608080528671.png" alt="Image" style="zoom: 50%;" />
    - ![图片](../../../Image/FYoxJ3G.png)
    - -p：显示友好提示，需在bash下使用
      - 用zsh 不支持 read 直接用 -p， 得切换成 bash，一般写shell 脚本也是用bash，直接输入bash 就可以切换，输入zsh 就可以切换回来
    - -s：静默模式
      - 直接-p 后，输入的密码会暴漏出来，可以通过添加参数 -s 来变成秘密模式，这样，输入的内容别人就看不了了
    - -t：输入等待时长，超时结束(单位：s)
  - 输出：echo
    - -e：开启转义
  - 输出：printf
    - 和C语言的printf非常像！
    - <img src="../../../Image/eDTN857.png" alt="图片" style="zoom: 50%;" />
    - [PS] !和\n放一起有特殊含义，需要分开（）
    - bash下需要分开
      - zsh下可以分开，或用\转义
    - 一般对于特殊符号，需要警觉！
  
## 函数

  ![图片](../../../Image/ZPrTEAC.png)

  - 没有形参
  - 定义：写法很多，function、()、{}组合搭配，第3种更类似C语言写法
  - 调用：函数名 参数...
  - ![图片](../../../Image/QNPEgM5.png)
    - 加function方便阅读
- ❗【注意】shell中函数return的返回值有限制，范围是0-255，溢出会循环换算
  
## 流程控制

do——done、if——then——fi、case——esac

  ### 【重点】TEST表达式⭐

  - 可判断类型：字符串、整型、文件
  - ❗ 【注意】条件为真时，返回0，否则返回非0
    - Linux中命令的返回值也是如此，0才代表成功
  - [PS]
    - STRING1 = STRING2 也可以用== 【推荐后者，两个中括号[[ ]]支持】
  - -G FILE：文件存在并且被有效组ID拥有
      - 如果组被解散了，则组控制的文件的组ID就是无效的
  - 具体可查阅man手册：man test

### 分支结构

**if**

  ![图片](../../../Image/jskkNPD.png)

- if用两个中括号[[ ]]的写法，更高级，与TEST表达式兼容性更好
    - 而一个中括号[ ]是很多年前的写法，不推荐，两个中括号
  - 参考[Linux Shell 中 ()、(())、[\]、[[]]、{} 的作用](https://jishuin.proginn.com/p/763bfbd322c2)——博客
  

**case**

  ![图片](../../../Image/Gcmmsqo.png)

- 分号;;不能没有！相当于break，加了break也要有
  - 默认情况可用*)
- case用的较少，一般用来做菜单，比if更美观
  
### 循环结构

**for**

![图片](../../../Image/RErKYyC.png)

- 利用seq生成序列（效率较低）
  

![图片](../../../Image/dijMTBK.png)

- 利用ls的匹配规则
  
  ![图片](../../../Image/4fYJlKD.png)

  - for的两种形式
- 双小括号(())中的内容只要符合C语言运算规则即可，变量可以不使用变量前缀$，可以写i++，平常不可以用++
  

**while**

![图片](../../../Image/ph9c75d.png)

- 同样适用test表达式
  
- 可以初始化变量，否则第一次echo num时，num是空值，表现为空行
  
  - 当遇到后面的+1时，系统判定它为整数类型，就当做整数用
  

**until**

![图片](../../../Image/ArbsZlq.png)

- 与while唯一的区别在于：until写的是停止条件，while写的是循环条件
  
## 数组（shell 的难点，搞定就没问题了）

![图片](../../../Image/1KrfABS.png)

- 数组赋值【方式①】和调用
  

![图片](../../../Image/vxZJCeL.png)

- 【常用的数组操作】还可以输出数组元素的下标，见后
  

![图片](../../../Image/XkR8WFI.png)

- 声明数组：declare -a num，方便阅读，不声明也可以 [弱类型语言]
  - 赋值【方式②、③】
  - num[2]=10 num[5]=7 num[100]=3.2.4
    - num=(1 a b 10)
  - 数组元素不一定要连续赋值（与C语言不同之处），且可以为任意类型
    - 【常用的数组操作】加!：输出所有数组元素对应的下标，可以看出不是连续的
  
  【其它数组操作】
  

![图片](../../../Image/kCdnBAz.png)

- +=：追加
  
  - unset：删除数组，或元素 [通过下标删除]
- sort : 数组排序
  - ${arr[*]}   是输出数组内容
  - ${arr[@]}  是输出数组内容
  - ${!arr[@]} 是输出数组中所有有值的下标
- ${#arr[@]} 是输出数组元素个数
  - [PS] 赋值方式③对多个空格也只作一个分隔符

  **应用**

  ![图片](../../../Image/KCso9pi.png)
  
  - 可以用来存储文件名列表
- 【注意】赋值方式③给数组赋值是以空格作为分隔符，所以如果文件名里有空格，需要特殊处理
  - 【PS】素数筛、线性筛

  # 随堂练习

  ## 1~100的偶数和

  ![图片](../../../Image/U3SE9J8.png)
  
- $[ ]可用来做整数运算
  - seq效率稍低

  ## 暴力求素数

  ![图片](../../../Image/Tf9JTfx.png)
  
  - 函数的return值
    - 通过$?获得，在调用函数后echo $?即可，但是return值有范围限制0~255！
    - 通过命令替换符``取到
  - 注意对于循环变量i的冲突问题：定义局部变量
  - 🆒调试程序
    - 习惯：适当的echo输出
  - 全局调试：bash -x *.sh
    - 局部调试：set -x [调试代码区域] set +x

  ## 素数筛

  ![img](../../../Image/oIUAfkz.png)
  
- 方式一方便操作素数，且输出时可减少判断
  - 方式二还可以操作合数

  【两种方法效果比较】求2~10000的素数和

  ![img](../../../Image/GbtW6YK.png)

  - 9.prime.sh 暴力法 —— 10.prime.sh 素数筛

  # 附加知识点

  - .sh脚本可以直接bash或source执行，如果要使用./需要有可执行权限

    - [source、sh、bash、./有什么区别](https://www.cnblogs.com/pcat/p/5467188.html)——cnblogs

  - set -x可以开启shell调试

  - Shell命令替换：将命令的输出结果赋值给变量

    ——C语言中文网
  
  - $() 支持嵌套，反引号``不行
    
- $() 仅在 Bash 中有效，而反引号``可在多种 Shell 中使用
    
  - 双小括号(())中的内容
  
    - 只要符合C语言运算规则即可
  - 变量可以不使用变量前缀$
  
  - 可以写i++，平常不可以用++
  
  - ⭐在Shell中，变量还未定义时，其值为空，echo输出表现为空行
  
  - ⭐空格问题【严格】
  
- 赋值语句：=左右不能有空格
    
- TEST表达式：[[ ]]两端必须有空格
    
- 对于变量名i_i，如果用i_i，会将*i**i*，会将i与_i拼接，所以要用${i_i}
  
  - time + bash + 程序，计时用的，计算这个程序运行花了多少时间
  
  - {}X == X ： 在{} 后面加上x这个值，判断加上之后是否还会等于X这个值
  
# Tips
  
  - 写Shell脚本
  
    - 不要太考虑性能，单纯做数学计算效率低
  - 为的是快速解决一个问题，用来规划所有任务的流程
  
    - 做操作前记得加【备份】操作
- 一般是让系统做事情，难于操作特定的程序做事情
      
- 程序一般有自己的参数设置，但不具有普适性
      
- API一般指服务
  
- ⭐[Shell 风格指南](https://zh-google-styleguide.readthedocs.io/en/latest/google-shell-styleguide/contents/)——Google 开源项目风格指南——Shell编程规范
  
- Shell脚本多行注释和单行注释的方法
  
    ——博客
  
    - :<<! ... !
  
  - 可以了解[let](https://www.runoob.com/linux/linux-comm-let.html)——菜鸟教程，方便的语法
  
  ------
  
  # 课程速记
  
  ![图片](../../../Image/ErJdxj5.png)![图片](../../../Image/vvhOeW9.png)![图片](../../../Image/jwZAXCe.png)